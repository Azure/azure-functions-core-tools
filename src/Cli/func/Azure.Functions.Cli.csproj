<Project Sdk="Microsoft.NET.Sdk" InitialTargets="ExcludeWorkersFromReadyToRun">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <OutputType>Exe</OutputType>
    <AssemblyName>func</AssemblyName>
    <RuntimeIdentifiers>win-x64;win-x86;win-arm64;linux-x64;osx-x64;osx-arm64</RuntimeIdentifiers>
    <Nullable>disable</Nullable>
    <DisableImplicitNamespaceImports>true</DisableImplicitNamespaceImports>
  </PropertyGroup>

  <PropertyGroup>
    <PackAsTool>true</PackAsTool>
    <ToolCommandName>func</ToolCommandName>
    <PackageId>Microsoft.Azure.Functions.CoreTools</PackageId>
  </PropertyGroup>

  <PropertyGroup Condition="'$(RuntimeIdentifier)' == 'win-x64' OR '$(RuntimeIdentifier)' == 'win-x86'">
    <PublishReadyToRun>false</PublishReadyToRun>
    <PublishReadyToRunShowWarnings>false</PublishReadyToRunShowWarnings>
  </PropertyGroup>

  <ItemGroup>
    <Content Include="$(EngRoot)tools\python\packapp\__main__.py">
      <Link>tools\python\packapp\__main__.py</Link>
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Autofac" />
    <PackageReference Include="Azure.Identity"/>
    <PackageReference Include="Azure.Security.KeyVault.Secrets" />
    <PackageReference Include="Colors.Net" />
    <PackageReference Include="AccentedCommandLineParser" />
    <PackageReference Include="Microsoft.ApplicationInsights" />
    <PackageReference Include="Microsoft.AspNetCore.DataProtection" />
    <PackageReference Include="Microsoft.Azure.DurableTask.AzureStorage.Internal" />
    <PackageReference Include="Microsoft.Azure.WebJobs.Script.WebHost" />
    <PackageReference Include="Microsoft.Build" />
    <PackageReference Include="Microsoft.Identity.Client" />
    <PackageReference Include="Newtonsoft.Json" />
    <PackageReference Include="NuGet.Packaging" />
    <PackageReference Include="System.Formats.Asn1" />
    <PackageReference Include="StyleCop.Analyzers" />
    <PackageReference Include="WindowsAzure.Storage" />
    <PackageReference Include="YamlDotNet" />
    <!-- Transitive dependency -->
    <PackageReference Include="System.Text.Json" />
  </ItemGroup>

  <ItemGroup Condition="'$(NoWorkers)' != 'true'">
    <PackageReference Include="Microsoft.Azure.Functions.JavaWorker" />
    <PackageReference Include="Microsoft.Azure.Functions.NodeJsWorker" />
    <PackageReference Include="Microsoft.Azure.Functions.PowerShellWorker.PS7.0" />
    <PackageReference Include="Microsoft.Azure.Functions.PowerShellWorker.PS7.2" />
    <PackageReference Include="Microsoft.Azure.Functions.PowerShellWorker.PS7.4" />
    <PackageReference Include="Microsoft.Azure.Functions.PythonWorker" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="$(SrcRoot)GoZipTool\GoZipTool.csproj">
      <Properties>ResolvedRuntimeIdentifier=$(RuntimeIdentifier);TargetFramework=$(TargetFramework)</Properties>
    </ProjectReference>
  </ItemGroup>

  <ItemGroup>
    <None Include="$(RepoRoot)out\pub\Azure.Functions.Cli\$(Configuration)_$(TargetFramework)\tools\python\packapp\__main__.py" Pack="true" PackagePath="content" />
    <None Include="$(RepoRoot)out\pub\Azure.Functions.Cli\$(Configuration)_$(TargetFramework)\tools\python\packapp\__main__.py" Pack="true" PackagePath="contentFiles/any/$(TargetFramework)" />
    <None Include="$(RepoRoot)out\pub\Azure.Functions.Cli\$(Configuration)_$(TargetFramework)\**\*" Pack="true" PackagePath="tools/$(TargetFramework)/any" />
  </ItemGroup>

  <Target Name="ExcludeWorkersFromReadyToRun">
    <CreateItem Include="%(None.Filename)%(None.Extension)"
      Condition="$([System.String]::new('%(None.TargetPath)').StartsWith('workers'))"
      PreserveExistingMetadata="false">
      <Output TaskParameter="Include" ItemName="PublishReadyToRunExclude" />
    </CreateItem>
  </Target>
</Project>