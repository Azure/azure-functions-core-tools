<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Customize these properties as needed -->
    <DistLibVersion>0.3.9</DistLibVersion>
    <DistLibUrl>https://github.com/vsajip/distlib/archive/$(DistLibVersion).zip</DistLibUrl>
    <EffectiveOutputPath Condition="'$(PublishDir)' != ''">$(PublishDir)</EffectiveOutputPath>
    <EffectiveOutputPath Condition="'$(PublishDir)' == ''">$(OutputPath)</EffectiveOutputPath>
    <ToolsPath>$(EffectiveOutputPath)\tools</ToolsPath>
    <DistLibZip>$(ToolsPath)\distlib.zip</DistLibZip>
    <DistLibUnzipped>$(ToolsPath)\distlib-$(DistLibVersion)</DistLibUnzipped>
    <DestDistLib>$(ToolsPath)\python\packapp\distlib</DestDistLib>
  </PropertyGroup>

  <Target Name="SetupDistlib" AfterTargets="Build">
    <Message Text="Setting up 'distlib' tool in: $(DestDistLib)" Importance="high" />

    <!-- Download distlib -->
    <DownloadFile
      SourceUrl="$(DistLibUrl)"
      DestinationFolder="$(ToolsPath)"
      DestinationFileName="distlib.zip" />

    <!-- Extract zip -->
    <Unzip
      SourceFiles="$(DistLibZip)"
      DestinationFolder="$(ToolsPath)" />

    <!-- Define the source distlib folder that we need -->
    <PropertyGroup>
      <SourceDistLib>$(DistLibUnzipped)\distlib</SourceDistLib>
    </PropertyGroup>

    <!-- Validate existence of source distlib folder -->
    <Error
      Condition="!Exists('$(SourceDistLib)')"
      Text="Expected distlib folder not found in $(SourceDistLib)" />

    <!-- Copy all files inside the distlib folder to the destination -->
    <ItemGroup>
      <DistLibFiles Include="$(SourceDistLib)\**\*" />
    </ItemGroup>

    <Copy
      SourceFiles="@(DistlibFiles)"
      DestinationFiles="@(DistlibFiles->'$(DestDistLib)\%(RecursiveDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="true" />

    <!-- Cleanup -->
    <Delete Files="$(DistLibZip)" />
    <RemoveDir Directories="$(DistLibUnzipped)" />
  </Target>

</Project>
