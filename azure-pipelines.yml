name: $(Build.SourceBranchName)_$(Build.Reason)_$(devops_buildNumber)

pr:
  branches:
    include:
    - master
    - dev

trigger:
  branches:
    include:
    - dev
    - master

pool:
  vmImage: 'vs2017-win2016'

variables:
  devops_buildNumber: $[counter(format(''), 1500)]
  APPVEYOR_REPO_BRANCH: $[coalesce(variables['System.PullRequest.TargetBranch'], variables['Build.SourceBranchName'])]
  APPVEYOR_REPO_COMMIT: $(Build.SourceVersion)

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      '$branch = "$(APPVEYOR_REPO_BRANCH)" |
      Write-Host "Target branch: ''$branch''" |
      $parts = $branch.Split("/") |
      $branchName = $parts[$parts.Length - 1] |
      Write-Host "Adjusted target branch: ''$branchName''" |
      Write-Host "##vso[task.setvariable variable=APPVEYOR_REPO_BRANCH]$branchName"'
- task: NuGetToolInstaller@1
  inputs:
    versionSpec: 
- task: PowerShell@2
  inputs:
    filePath: '.\build.ps1'
  displayName: 'Executing build script'
