# Because all of our nightly build artifacts will have a pre-release version (i.e. 4.1.0-ci.<buildnumber>),
# we cannot use '*' wildcard matching to get the latest version. Instead, we will fetch the latest version
# from the feed using the Azure DevOps REST API.
parameters:
  - name: defaultCliOnly
    type: boolean
    default: false

steps:
- task: PowerShell@2
  displayName: 'Get latest artifact version'
  inputs:
    targetType: 'inline'
    script: |
      # Fetch the latest version of the func-cli package from the feed for each package
      $headers = @{ Authorization = "Bearer $env:SYSTEM_ACCESSTOKEN" }

      # Import the function from the script
      . "$(Build.SourcesDirectory)/eng/scripts/get-latest-package-version.ps1"
      
      # Get version for each package
      $funcCliVersion = Get-LatestPackageVersion -packageName "func-cli" -headers $headers
      Write-Host "##vso[task.setvariable variable=FUNC_CLI_VERSION]$funcCliVersion"
      Write-Host "func-cli version: $funcCliVersion"
      
      $funcCliInprocVersion = Get-LatestPackageVersion -packageName "func-cli-inproc" -headers $headers
      Write-Host "##vso[task.setvariable variable=FUNC_CLI_INPROC_VERSION]$funcCliInprocVersion"
      Write-Host "func-cli-inproc version: $funcCliInprocVersion"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)

- task: DownloadPackage@1
  displayName: 'Download func-cli from feed'
  inputs:
    packageType: 'upack'
    feed: 'internal/core-tools-nightly-build'
    definition: 'func-cli'
    version: '$(FUNC_CLI_VERSION)'
    downloadPath: '$(Pipeline.Workspace)/func-cli-default/func-cli'

- ${{ if not(parameters.defaultCliOnly) }}:
  - task: DownloadPackage@1
    displayName: 'Download func-cli-inproc from feed'
    inputs:
      packageType: 'upack'
      feed: 'internal/core-tools-nightly-build'
      definition: 'func-cli-inproc'
      version: '$(FUNC_CLI_INPROC_VERSION)'
      downloadPath: '$(Pipeline.Workspace)/func-cli-inproc'

  - task: DownloadPackage@1
    displayName: 'Download func-cli-host from feed'
    inputs:
      packageType: 'upack'
      feed: 'internal/core-tools-nightly-build'
      definition: 'func-cli-host'
      version: '$(FUNC_CLI_VERSION)'
      downloadPath: '$(Pipeline.Workspace)/func-cli-host'
