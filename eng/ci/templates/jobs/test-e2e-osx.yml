parameters:
# When true, build CLI inline instead of downloading from a previous stage
# Use for public/PR builds where we want fast parallel execution
- name: buildCliInline
  type: boolean
  default: false

# Artifact name to download (only used when buildCliInline is false)
# Official builds use 'func-cli-osx-x64', public builds use 'e2e-cli-osx-x64'
- name: artifactName
  type: string
  default: 'func-cli-osx-x64'

jobs:
# Build CLI job (only when buildCliInline is true)
- ${{ if eq(parameters.buildCliInline, true) }}:
  - job: Build_OSX_CLI
    timeoutInMinutes: '30'
    displayName: 'Build CLI (osx-x64)'

    pool:
      name: Azure Pipelines
      image: macOS-latest
      os: macOS

    steps:
    - script: |
        brew install go
        go version
      displayName: 'Install Go'

    - task: UseDotNet@2
      displayName: Install .NET SDK from global.json
      inputs:
        packageType: sdk
        useGlobalJson: true

    - pwsh: |
        dotnet publish src/Cli/func/Azure.Functions.Cli.csproj `
          -c Release `
          -f net8.0 `
          -r osx-x64 `
          --self-contained `
          -o $(Build.ArtifactStagingDirectory)/artifacts/osx-x64
      displayName: 'Publish CLI (osx-x64)'

    - bash: |
        chmod +x $(Build.ArtifactStagingDirectory)/artifacts/osx-x64/func
        chmod +x $(Build.ArtifactStagingDirectory)/artifacts/osx-x64/gozip
      displayName: 'Make CLI binaries executable'

    - task: 1ES.PublishPipelineArtifact@1
      displayName: 'Publish CLI Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/osx-x64'
        artifactName: 'e2e-cli-osx-x64'

# Run E2E tests
- job: OSX_E2E_Test
  ${{ if eq(parameters.buildCliInline, true) }}:
    dependsOn: Build_OSX_CLI
  timeoutInMinutes: '60'
  displayName: 'E2E Test:'

  pool:
    name: Azure Pipelines
    image: macOS-latest
    os: macOS

  strategy:
    matrix:
      dotnetIsolated_osx_x64:
        languageWorker: 'DotnetIsolated'
        runtime: 'osx-x64'
      node_osx_x64:
        languageWorker: 'Node'
        runtime: 'osx-x64'
      powershell_osx_x64:
        languageWorker: 'Powershell'
        runtime: 'osx-x64'
      python_osx_x64:
        languageWorker: 'Python'
        runtime: 'osx-x64'
      custom_osx_x64:
        languageWorker: 'Custom'
        runtime: 'osx-x64'

  steps:
  - pwsh: ./eng/scripts/start-emulators.ps1
    displayName: 'Start emulators (NoWait)'

  - script: |
      brew install go
      go version
    displayName: 'Install Go'

  - script: |
      sudo chown -R $(id -u):$(id -g) ~/.npm
      npm install -g @azure/functions
    displayName: 'Install @azure/functions'

  - template: /eng/ci/templates/steps/install-e2e-tools.yml@self
    parameters:
      worker: $(languageWorker)

  # Download CLI artifact (when NOT building inline - official builds)
  - ${{ if eq(parameters.buildCliInline, false) }}:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download CLI Artifact from Build'
      inputs:
        artifactName: '${{ parameters.artifactName }}'
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/$(runtime)'

    - bash: |
        cd $(Build.ArtifactStagingDirectory)/artifacts/$(runtime)
        # Find and extract the CLI zip
        ZIP_FILE=$(ls Azure.Functions.Cli.$(runtime).*.zip 2>/dev/null | head -1)
        if [ -n "$ZIP_FILE" ]; then
          echo "Extracting $ZIP_FILE..."
          unzip -o "$ZIP_FILE"
          rm "$ZIP_FILE"
        fi
        chmod +x func gozip 2>/dev/null || true
        ls -la
      displayName: 'Extract and prepare CLI'

  # Download CLI artifact (when building inline - public builds)
  - ${{ if eq(parameters.buildCliInline, true) }}:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download CLI Artifact'
      inputs:
        artifactName: 'e2e-cli-osx-x64'
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/$(runtime)'

    - bash: |
        chmod +x $(Build.ArtifactStagingDirectory)/artifacts/$(runtime)/func
        chmod +x $(Build.ArtifactStagingDirectory)/artifacts/$(runtime)/gozip
      displayName: 'Make CLI binaries executable'

  # Cleanup temp directories before running tests
  - bash: |
      echo "Cleaning up temp directories..."
      rm -rf /tmp/func-e2e-* || true
      rm -rf ~/.azure-functions-core-tools/dotnet-templates-custom-hives || true
      df -h
    displayName: 'Cleanup temp directories'

  - template: /eng/ci/templates/steps/run-e2e-tests.yml@self
    parameters:
      worker: $(languageWorker)
      runtime: $(runtime)

  # Always cleanup after tests, even on failure
  - bash: |
      echo "Post-test cleanup..."
      rm -rf /tmp/func-e2e-* || true
      rm -rf ~/.azure-functions-core-tools/dotnet-templates-custom-hives || true
      df -h
    displayName: 'Post-test cleanup'
    condition: always()