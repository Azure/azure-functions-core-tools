parameters:
# When true, build CLI inline instead of downloading from a previous stage
# Use for public/PR builds where we want fast parallel execution
- name: buildCliInline
  type: boolean
  default: false

# Artifact name to download (only used when buildCliInline is false)
# Official builds use 'func-cli-win-x64', public builds use 'e2e-cli-win-x64'
- name: artifactName
  type: string
  default: 'func-cli-win-x64'

jobs:
# Build CLI job (only when buildCliInline is true)
- ${{ if eq(parameters.buildCliInline, true) }}:
  - job: Build_Windows_CLI
    timeoutInMinutes: '30'
    displayName: 'Build CLI (win-x64)'

    pool:
      name: 1es-pool-azfunc-public
      image: 1es-windows-2022
      os: windows

    steps:
    - task: UseDotNet@2
      displayName: Install .NET SDK from global.json
      inputs:
        packageType: sdk
        useGlobalJson: true

    - pwsh: |
        dotnet publish src/Cli/func/Azure.Functions.Cli.csproj `
          -c Release `
          -f net8.0 `
          -r win-x64 `
          --self-contained `
          -o $(Build.ArtifactStagingDirectory)/artifacts/win-x64
      displayName: 'Publish CLI (win-x64)'

    - task: 1ES.PublishPipelineArtifact@1
      displayName: 'Publish CLI Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/win-x64'
        artifactName: 'e2e-cli-win-x64'

# Run E2E tests
- job: Windows_E2E_Test
  ${{ if eq(parameters.buildCliInline, true) }}:
    dependsOn: Build_Windows_CLI
  timeoutInMinutes: '60'
  displayName: 'E2E Test:'

  pool:
    name: 1es-pool-azfunc-public
    image: 1es-windows-2022
    os: windows

  strategy:
    matrix:
      dotnetIsolated_win_x64:
        languageWorker: 'DotnetIsolated'
        runtime: 'win-x64'
      node_win_x64:
        languageWorker: 'Node'
        runtime: 'win-x64'
      powershell_win_x64:
        languageWorker: 'Powershell'
        runtime: 'win-x64'
      python_win_x64:
        languageWorker: 'Python'
        runtime: 'win-x64'
      custom_win_x64:
        languageWorker: 'Custom'
        runtime: 'win-x64'

  steps:
  - pwsh: ./eng/scripts/start-emulators.ps1 -NoWait
    displayName: 'Start emulators (NoWait)'

  - template: /eng/ci/templates/steps/install-e2e-tools.yml@self
    parameters:
      worker: $(languageWorker)

  # Download CLI artifact (when NOT building inline - official builds)
  - ${{ if eq(parameters.buildCliInline, false) }}:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download CLI Artifact from Build'
      inputs:
        artifactName: '${{ parameters.artifactName }}'
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/$(runtime)'

    - pwsh: |
        $artifactPath = "$(Build.ArtifactStagingDirectory)/artifacts/$(runtime)"
        Set-Location $artifactPath
        # Find and extract the CLI zip
        $zipFile = Get-ChildItem -Filter "Azure.Functions.Cli.$(runtime).*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "Extracting $($zipFile.Name)..."
          Expand-Archive -Path $zipFile.FullName -DestinationPath . -Force
          Remove-Item $zipFile.FullName
        }
        Get-ChildItem
      displayName: 'Extract and prepare CLI'

  # Download CLI artifact (when building inline - public builds)
  - ${{ if eq(parameters.buildCliInline, true) }}:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download CLI Artifact'
      inputs:
        artifactName: 'e2e-cli-win-x64'
        targetPath: '$(Build.ArtifactStagingDirectory)/artifacts/$(runtime)'

  # Cleanup temp directories before running tests
  - pwsh: |
      Write-Host "Cleaning up temp directories..."
      Remove-Item -Path "$env:TEMP\func-e2e-*" -Recurse -Force -ErrorAction SilentlyContinue
      $hivePath = Join-Path $env:LOCALAPPDATA "azure-functions-core-tools\dotnet-templates-custom-hives"
      if (Test-Path $hivePath) {
        Remove-Item -Path $hivePath -Recurse -Force -ErrorAction SilentlyContinue
      }
      Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{N='FreeGB';E={[math]::Round($_.Free/1GB,2)}}
    displayName: 'Cleanup temp directories'

  - template: /eng/ci/templates/steps/run-e2e-tests.yml@self
    parameters:
      worker: $(languageWorker)
      runtime: $(runtime)

  # Always cleanup after tests, even on failure
  - pwsh: |
      Write-Host "Post-test cleanup..."
      Remove-Item -Path "$env:TEMP\func-e2e-*" -Recurse -Force -ErrorAction SilentlyContinue
      $hivePath = Join-Path $env:LOCALAPPDATA "azure-functions-core-tools\dotnet-templates-custom-hives"
      if (Test-Path $hivePath) {
        Remove-Item -Path $hivePath -Recurse -Force -ErrorAction SilentlyContinue
      }
    displayName: 'Post-test cleanup'
    condition: always()