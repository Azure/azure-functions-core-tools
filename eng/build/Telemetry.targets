<Project>

    <PropertyGroup Condition="'$(PublicRelease)' == 'true'">
        <DefineConstants>$(DefineConstants);IS_PUBLIC_RELEASE</DefineConstants>
    </PropertyGroup>

    <Target Name="ReplaceTelemetryKey" BeforeTargets="BeforeCompile" Condition="'$(PublicRelease)' == 'true'">
        <Message Text="Replacing telemetry key in 'Constants.Build.cs'..." Importance="high" />

        <!-- Get telemetry key from environment variable -->
        <PropertyGroup>
            <TelemetryKey>$(TELEMETRY_INSTRUMENTATION_KEY)</TelemetryKey>
        </PropertyGroup>

        <ReadLinesFromFile File="Common\Constants.Build.cs">
            <Output TaskParameter="Lines" ItemName="FileLines" />
        </ReadLinesFromFile>

        <WriteLinesToFile File="Common\Constants.Build.cs"
            Lines="@(FileLines->Replace('__TELEMETRY_KEY__', '$(TelemetryKey)'))"
            Overwrite="true" />
    </Target>

</Project>